<!DOCTYPE html>
<html>
<head>
    <title>{{ app_title }} - Settings</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><path d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/><line x1='12' y1='14' x2='12' y2='10'/><line x1='14' y1='12' x2='10' y2='12'/><circle cx='12' cy='12' r='1'/></svg>">
    <style>
        body { 
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding: 0 8px;
        }

        .app-title-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            position: relative;
        }

        .app-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            padding-right: 170px; /* –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –±–µ–π–¥–∂–µ–π –≤ —Å—Ç—Ä–æ–∫—É */
        }

        .app-name {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.2;
        }

        .app-subtitle {
            font-size: 14px;
            color: #6c757d;
            font-weight: 400;
        }

        /* –ë–ï–ô–î–ñ–ò –í–ï–†–°–ò–ô –°–ü–†–ê–í–ê –û–¢ –ù–ê–ó–í–ê–ù–ò–Ø - –í –û–î–ù–û–ô –°–¢–†–û–ö–ï */
        .version-badges {
            position: absolute;
            top: -6px; /* –ß—É—Ç—å –≤—ã—à–µ */
            right: 0;
            display: flex;
            gap: 12px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–µ–π–¥–∂–∞–º–∏ */
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* –û–ë–©–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–°–ï–• –ë–ï–ô–î–ñ–ï–ô */
        .badge {
            background-color: #f8f9fa;
            color: #6c757d;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            line-height: 1.2;
        }

        .badge strong {
            color: #495057;
        }

        /* –¶–í–ï–¢–ê –î–õ–Ø –†–ê–ó–ù–´–• –¢–ò–ü–û–í –ë–ï–ô–î–ñ–ï–ô */
        .badge-role {
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å */
        }

        .badge-app-version {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border-color: #dee2e6;
            font-weight: 500;
        }

        .badge-app-version strong {
            color: #1a1a1a;
            font-weight: 600;
        }

        .badge-lib-version {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a6fd8;
            font-weight: 500;
        }

        .badge-lib-version strong {
            color: white;
            font-weight: 600;
        }
        .settings-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .settings-table th, .settings-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .settings-table th { background-color: #f2f2f2; }
        .source-database { color: #28a745; font-weight: bold; }
        .source-environment { color: #17a2b8; }
        .source-default { color: #6c757d; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–π */
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            margin: 20px 0 0 0;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .section-header.collapsed {
            margin-bottom: 0;
            border-radius: 8px 8px 8px 8px;
        }

        .section-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .section-content.collapsed {
            display: none;
        }

        .toggle-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        button {
            padding: 4px 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            white-space: nowrap;
            min-height: 35px;
            border-radius: 4px;
        }
        .btn-update {
            background: #007bff;
            color: white;
            border: none;
            margin-top: -4px;
            min-height: 32px;
            border-radius: 4px;
        }
        .btn-reset {
            background: #dc3545;
            color: white;
            border: none;
            margin-top: -4px;
            min-height: 32px;
            border-radius: 4px;
        }
        .btn-reset:disabled {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px dashed #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
            margin-top: -4px;
            min-height: 32px;
            border-radius: 4px;
        }
        .btn-reset:not(:disabled):hover { background: #c82333; }
        .value-info { font-size: 0.9em; color: #666; }
        .actions-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 300px;
            text-align: center;
        }
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden { display: none; }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            font-style: italic;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .col-type { width: 100px; }
        .col-source { width: 120px; }
        .col-values { width: 200px; }

        .input-container {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 100%;
        }

        .input-collapsed, .input-expanded {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            font-family: inherit;
            resize: none;
        }

        .sensitive-field .input-collapsed,
        .sensitive-field .input-expanded {
            padding-right: 40px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –≥–ª–∞–∑–∞ */
        }

        .input-collapsed {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: 32px;
            line-height: 24px;
        }

        .input-expanded {
            white-space: pre-wrap;
            word-break: break-all;
            height: auto;
            min-height: 32px;
            max-height: 50vh;
            overflow-y: hidden;
        }

        .input-expanded.need-scroll {
            overflow-y: auto;
        }

        .expand-toggle {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            padding: 4px 6px;
            z-index: 2;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sensitive-field .expand-toggle {
            right: 40px; /* –°–¥–≤–∏–≥–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∫–æ–Ω–∫–∞ –≥–ª–∞–∑–∞ */
        }

        .expand-toggle:hover {
            color: #007bff;
            background: #f8f9fa;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.2);
        }

        .expand-toggle::before {
            content: "‚§¢";
        }

        .expand-toggle.expanded::before {
            content: "‚§°";
        }

        .value-text {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            vertical-align: bottom;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
        .sensitive-field {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .sensitive-warning {
            color: #856404;
            font-size: 0.8em;
            font-style: italic;
            margin-top: 2px;
        }

        .masked-value {
            font-family: monospace;
            letter-spacing: 2px;
            color: #666;
        }

        .readonly-field {
            background-color: #f8f9fa;
            opacity: 0.7;
        }

        textarea:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            z-index: 2;
        }
        .toggle-visibility:hover {
            color: #343a40;
        }
        .toggle-visibility svg {
            width: 20px;
            height: 20px;
        }
        .page-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        #search-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="app-title-section">
            <div class="app-info">
                <div class="app-name">{{ app_title }}</div>
                <div class="app-subtitle">Application Settings Management</div>

                <!-- –ë–ï–ô–î–ñ–ò –í–ï–†–°–ò–ô –°–ü–†–ê–í–ê –û–¢ –ù–ê–ó–í–ê–ù–ò–Ø - –í –û–î–ù–û–ô –°–¢–†–û–ö–ï -->
                <div class="version-badges">
                    {% if app_version %}
                    <div class="badge badge-app-version">
                        <strong>v{{ app_version }}</strong>
                    </div>
                    {% endif %}

                    <div class="badge badge-lib-version">
                        Lib: <strong>v{{ lib_version }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="header-right">
            <!-- –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="badge badge-role">
                Current Role: <strong>{{ user_role or 'Guest' }}</strong>
            </div>
        </div>
    </div>

    <div id="message" class="hidden"></div>

    <div class="page-controls">
        <input type="search" id="search-input" placeholder="Search by name or description..." oninput="filterSettings()">
        <button type="button" onclick="resetAllSettings()"
                style="background: #dc3545; color: white;">
            Reset All Settings
        </button>
        <button type="button" onclick="toggleAllSections()"
                style="background: #6c757d; color: white;">
            Toggle All Sections
        </button>
    </div>

    {% for section_name, settings in settings_grouped.items() %}
    <div class="section-container">
        <div class="section-header {% if section_name == 'System' %}collapsed{% endif %}"
             onclick="toggleSection('{{ section_name }}')"
             id="header-{{ section_name }}">
            <span>{{ section_name }}</span>
            <span class="toggle-icon {% if section_name == 'System' %}collapsed{% endif %}"
                  id="toggle-{{ section_name }}">‚ñº</span>
        </div>
        <div class="section-content {% if section_name == 'System' %}collapsed{% endif %}"
             id="content-{{ section_name }}">
            <table class="settings-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Current Value & Actions</th>
                        <th class="col-type">Type</th>
                        <th class="col-source">Source</th>
                        <th class="col-values">Values</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for setting in settings %}
                    <tr id="row-{{ setting.name }}"
                        {% if setting.is_sensitive %}class="sensitive-field"{% endif %}
                        {% if not setting.allow_change %}class="readonly-field"{% endif %}>
                        <td class="setting-name">
                            <strong>{{ setting.name }}</strong>
                            {% if setting.is_sensitive %}
                            <div class="sensitive-warning">üîí Sensitive field</div>
                            {% endif %}
                            {% if not setting.allow_change %}
                            <div class="sensitive-warning">üö´ Read-only</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="input-group">
                                <div class="input-container">
                                    <textarea
                                        id="input-{{ setting.name }}"
                                        aria-label="Value for {{ setting.name }}"
                                        placeholder="{% if setting.is_sensitive %}Enter new sensitive value{% else %}Enter new value{% endif %}"
                                        class="input-collapsed"
                                        data-is-sensitive="{{ 'true' if setting.is_sensitive else 'false' }}"
                                        data-real-value="{{ setting.value }}"
                                        {% if not setting.allow_change %}disabled{% endif %}>{{ setting.value }}</textarea>
                                    
                                    {% if setting.is_sensitive and is_superuser %}
                                    <span class="toggle-visibility" onclick="toggleVisibility('{{ setting.name }}')">
                                        <!-- SVG –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS -->
                                    </span>
                                    {% endif %}

                                    <button type="button"
                                            class="expand-toggle"
                                            id="toggle-input-{{ setting.name }}"
                                            onclick="toggleInput('{{ setting.name }}')"
                                            style="display: none;"
                                            aria-label="Expand/collapse textarea"
                                            {% if not setting.allow_change %}disabled{% endif %}>
                                    </button>
                                </div>
                                <div class="actions-group">
                                    <button type="button" class="btn-update" onclick="updateSetting('{{ setting.name }}')"
                                            {% if not setting.allow_change %}disabled{% endif %}>
                                        Update
                                    </button>
                                    <div class="tooltip">
                                        {% if setting.can_reset and setting.allow_change %}
                                        <button type="button" class="btn-reset" onclick="resetSetting('{{ setting.name }}')">
                                            Reset
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn-reset" disabled>
                                            Reset
                                        </button>
                                        <span class="tooltiptext">
                                            {% if not setting.allow_change %}
                                            Reset not available for read-only settings
                                            {% else %}
                                            Reset available only for database values
                                            {% endif %}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="col-type">{{ setting.type }}</td>
                        <td class="col-source">
                            <span class="source-{{ setting.source }}">‚óè {{ setting.source }}</span>
                        </td>
                        <td class="col-values">
                            <div class="value-info">
                                <div>
                                    <strong>Env:</strong>
                                    {% if setting.environment_value is not none %}
                                        <div class="tooltip">
                                            <span class="value-text {% if setting.is_sensitive %}masked-value{% endif %}">
                                                {{ setting.environment_value }}
                                            </span>
                                            {% if setting.is_sensitive %}
                                            <span class="tooltiptext">
                                                This is a masked sensitive value
                                            </span>
                                            {% else %}
                                            <span class="tooltiptext">
                                                {{ setting.environment_value }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span style="color: #999; font-style: italic;">(not set)</span>
                                    {% endif %}
                                </div>
                                {% if setting.default_value is not none %}
                                <div>
                                    <strong>Default:</strong>
                                    <div class="tooltip">
                                        <span class="value-text {% if setting.is_sensitive %}masked-value{% endif %}">
                                            {{ setting.default_value }}
                                        </span>
                                        {% if setting.is_sensitive %}
                                        <span class="tooltiptext">
                                            This is a masked sensitive value
                                        </span>
                                        {% else %}
                                        <span class="tooltiptext">
                                            {{ setting.default_value }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="setting-description">{{ setting.description or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}

    <script>
        const API_BASE_PATH = "{{ api_base_path }}";
        const MASKED_VALUE = "‚Ä¢".repeat(8);
        const visibilityTimers = {};

        const EYE_ICON_SHOW = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        const EYE_ICON_HIDE = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>`;

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message message-${type}`;
            messageEl.classList.remove('hidden');

            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }

        function filterSettings() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.section-container').forEach(section => {
                let hasVisibleRows = false;
                section.querySelectorAll('tbody tr').forEach(row => {
                    const name = row.querySelector('.setting-name').textContent.toLowerCase();
                    const description = row.querySelector('.setting-description').textContent.toLowerCase();

                    if (name.includes(searchText) || description.includes(searchText)) {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—é —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ –≤ –Ω–µ–π –Ω–µ—Ç –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫
                section.style.display = hasVisibleRows ? '' : 'none';
            });
        }

        function toggleSection(sectionName) {
            const header = document.getElementById(`header-${sectionName}`);
            const content = document.getElementById(`content-${sectionName}`);
            const toggle = document.getElementById(`toggle-${sectionName}`);

            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
        function toggleAllSections() {
            const headers = document.querySelectorAll('.section-header');
            const allCollapsed = Array.from(headers).every(header => header.classList.contains('collapsed'));

            headers.forEach(header => {
                const sectionName = header.id.replace('header-', '');
                const content = document.getElementById(`content-${sectionName}`);
                const toggle = document.getElementById(`toggle-${sectionName}`);

                if (allCollapsed) {
                    // –ï—Å–ª–∏ –≤—Å–µ —Å–≤–µ—Ä–Ω—É—Ç—ã - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ
                    header.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                } else {
                    // –ï—Å–ª–∏ –Ω–µ –≤—Å–µ —Å–≤–µ—Ä–Ω—É—Ç—ã - —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å–µ
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ textarea
        function toggleInput(settingName) {
            const textarea = document.getElementById(`input-${settingName}`);
            const toggle = document.getElementById(`toggle-input-${settingName}`);

            if (textarea.classList.contains('input-collapsed')) {
                // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º
                textarea.classList.remove('input-collapsed');
                textarea.classList.add('input-expanded');
                toggle.classList.add('expanded');
                textarea.focus();
                adjustTextareaHeight(textarea);
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º
                textarea.classList.remove('input-expanded');
                textarea.classList.add('input-collapsed');
                toggle.classList.remove('expanded');
                textarea.style.height = '32px';
            }
            // –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
            checkTextareaOverflow(settingName);
        }

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
        function checkTextareaOverflow(settingName) {
            const textarea = document.getElementById(`input-${settingName}`);
            const toggle = document.getElementById(`toggle-input-${settingName}`);

            // –í —Å–≤–µ—Ä–Ω—É—Ç–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
            // –í —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–º —Ä–µ–∂–∏–º–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä–Ω—É—Ç—å
            if (textarea.classList.contains('input-collapsed')) {
                const isOverflowing = textarea.scrollWidth > textarea.clientWidth;
                toggle.style.display = isOverflowing ? 'block' : 'none';
            } else {
                toggle.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤—ã—Å–æ—Ç—ã textarea
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            const contentHeight = textarea.scrollHeight;
            const maxHeight = window.innerHeight * 0.5;
            const newHeight = Math.min(contentHeight, maxHeight);
            textarea.style.height = newHeight + 'px';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
            if (contentHeight > maxHeight) {
                textarea.classList.add('need-scroll');
            } else {
                textarea.classList.remove('need-scroll');
            }
        }

        function toggleVisibility(settingName) {
            const textarea = document.getElementById(`input-${settingName}`);
            const eye = textarea.closest('.input-container').querySelector('.toggle-visibility');
            const isMasked = textarea.dataset.isMasked === 'true';

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if (visibilityTimers[settingName]) {
                clearTimeout(visibilityTimers[settingName]);
                delete visibilityTimers[settingName];
            }

            if (isMasked) {
                textarea.value = textarea.dataset.realValue;
                eye.innerHTML = EYE_ICON_HIDE;
                textarea.dataset.isMasked = 'false';

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è
                visibilityTimers[settingName] = setTimeout(() => {
                    textarea.value = MASKED_VALUE;
                    eye.innerHTML = EYE_ICON_SHOW;
                    textarea.dataset.isMasked = 'true';
                }, 5000);

            } else {
                textarea.value = MASKED_VALUE;
                eye.innerHTML = EYE_ICON_SHOW;
                textarea.dataset.isMasked = 'true';
            }
        }

        async function updateSetting(settingName) {
            const textarea = document.getElementById(`input-${settingName}`);
            const isSensitive = textarea.dataset.isSensitive === 'true';
            
            let value;
            // –ï—Å–ª–∏ –ø–æ–ª–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ, –º—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞,
            // –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–≤–µ–ª –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å–∫–æ–π).
            if (isSensitive) {
                if (textarea.dataset.isMasked === 'false') {
                    value = textarea.value;
                } else {
                    value = textarea.dataset.realValue;
                }
            } else {
                value = textarea.value;
            }
            value = value.trim();


            if (!value) {
                showMessage('Please enter a value', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_PATH}/${settingName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `value=${encodeURIComponent(value)}`
                });

                if (response.ok) {
                    showMessage(`Setting "${settingName}" updated successfully`);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                    const resetButton = document.querySelector(`#row-${settingName} .btn-reset`);
                    if (resetButton) {
                        resetButton.disabled = false;
                        resetButton.onclick = () => resetSetting(settingName);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞ "database"
                    const sourceElement = document.querySelector(`#row-${settingName} .col-source span`);
                    if (sourceElement) {
                        sourceElement.className = 'source-database';
                        sourceElement.textContent = '‚óè database';
                    }
                    if (isSensitive) {
                        textarea.dataset.realValue = value;
                        // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤–∏–¥–∏–º—ã–º, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –≤–∏–¥–∏–º–æ
                        if (textarea.dataset.isMasked === 'false') {
                            textarea.value = value;
                        } else {
                            textarea.value = MASKED_VALUE;
                        }
                    }
                } else {
                    const result = await response.json();
                    showMessage('Error: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        async function resetSetting(settingName) {
            if (confirm(`Reset setting "${settingName}" to environment/default value?`)) {
                try {
                    const response = await fetch(`${API_BASE_PATH}/${settingName}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showMessage(`Setting "${settingName}" reset successfully`);
                        updateSettingUI(settingName, result.value, result.source);
                    } else {
                        const result = await response.json();
                        showMessage('Error resetting setting: ' + (result.detail || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function updateSettingUI(settingName, value, source) {
            const textarea = document.getElementById(`input-${settingName}`);

            if (textarea) {
                const isSensitive = textarea.dataset.isSensitive === 'true';
                textarea.dataset.realValue = value;
                if (isSensitive) {
                    textarea.value = MASKED_VALUE;
                    textarea.dataset.isMasked = 'true';
                    const eye = textarea.closest('.input-container').querySelector('.toggle-visibility');
                    if(eye) eye.innerHTML = EYE_ICON_SHOW;
                } else {
                    textarea.value = value;
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä
            const sourceElement = document.querySelector(`#row-${settingName} .col-source span`);
            if (sourceElement) {
                sourceElement.className = `source-${source}`;
                sourceElement.textContent = `‚óè ${source}`;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Reset - –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ disabled
            const resetButton = document.querySelector(`#row-${settingName} .btn-reset`);
            if (resetButton) {
                resetButton.disabled = true;
                resetButton.onclick = null;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
            checkTextareaOverflow(settingName);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function resetAllSettings() {
            if (confirm('Are you sure you want to reset ALL settings? This will remove all database values.')) {
                try {
                    const response = await fetch(`${API_BASE_PATH}/actions/reset-all`, { method: 'POST' });
                    if (response.ok) {
                        showMessage('All settings reset successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        const result = await response.json();
                        showMessage('Error: ' + (result.detail || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('textarea').forEach(textarea => {
                const settingName = textarea.id.replace('input-', '');
                const isSensitive = textarea.dataset.isSensitive === 'true';

                if (isSensitive) {
                    textarea.dataset.isMasked = 'true';
                    textarea.value = MASKED_VALUE;
                    const eye = textarea.closest('.input-container').querySelector('.toggle-visibility');
                    if (eye) {
                        eye.innerHTML = EYE_ICON_SHOW;
                    }
                }
                
                checkTextareaOverflow(settingName);
                textarea.addEventListener('input', function() {
                    checkTextareaOverflow(settingName);
                    if (this.classList.contains('input-expanded')) {
                        adjustTextareaHeight(this);
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                textarea.addEventListener('resize', function() {
                    checkTextareaOverflow(settingName);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        if (e.ctrlKey || this.classList.contains('input-expanded')) {
                            // Ctrl+Enter –∏–ª–∏ Enter –≤ —Ä–∞—Å–∫—Ä—ã—Ç–æ–º —Ä–µ–∂–∏–º–µ - –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                            if (!e.ctrlKey) {
                                setTimeout(() => {
                                    adjustTextareaHeight(this);
                                    checkTextareaOverflow(settingName);
                                }, 0);
                            }
                        } else {
                            // Enter –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–º —Ä–µ–∂–∏–º–µ - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
                            e.preventDefault();
                            if (confirm(`Update setting "${settingName}" to "${this.value}"?`)) {
                                updateSetting(settingName);
                            }
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>